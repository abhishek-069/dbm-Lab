# DBMS Lab - 2

## 1. Creating Tables

```sql
CREATE TABLE SALESMAN(
  SALESMAN_ID INT PRIMARY KEY,
  NAME VARCHAR(20),
  CITY VARCHAR(20),
  COMMISSION VARCHAR(20)
);

CREATE TABLE CUSTOMER(
  CUSTOMER_ID INT PRIMARY KEY,
  CUSTOMER_NAME VARCHAR(20),
  CITY VARCHAR(20),
  GRADE INT,
  SALESMAN_ID REFERENCES SALESMAN(SALESMAN_ID) ON DELETE SET NULL
);

CREATE TABLE ORDERS(
  ORD_ID INT PRIMARY KEY,
  PURCHASE_AMT NUMBER,
  ORD_DATE DATE,
  CUSTOMER_ID REFERENCES CUSTOMER(CUSTOMER_ID) ON DELETE SET NULL,
  SALESMAN_ID REFERENCES SALESMAN(SALESMAN_ID) ON DELETE SET NULL
);
```
## 2. Inserting Data
```sql
-- Salesmen
INSERT INTO SALESMAN VALUES(1000, 'JOHN', 'BANGALORE', '25%');
INSERT INTO SALESMAN VALUES(2000, 'RAVI', 'BANGALORE', '20%');
INSERT INTO SALESMAN VALUES(3000, 'KUMAR', 'MYSURU', '15%');
INSERT INTO SALESMAN VALUES(4000, 'SMITH', 'DELHI', '30%');
INSERT INTO SALESMAN VALUES(5000, 'HARSHA', 'HYDERBAD', '15%');

-- Customers
INSERT INTO CUSTOMER VALUES(10, 'PREETHI', 'BANGALORE', 100, 1000);
INSERT INTO CUSTOMER VALUES(11, 'VIVEK', 'MANGALORE', 300, 1000);
INSERT INTO CUSTOMER VALUES(12, 'BHASKAR', 'CHENNAI', 400, 2000);
INSERT INTO CUSTOMER VALUES(13, 'CHETHAN', 'BENGALORE', 200, 2000);
INSERT INTO CUSTOMER VALUES(14, 'MAMATHA', 'BENGALORE', 400, 3000);

-- Orders
INSERT INTO ORDERS VALUES(50, 5000, '04-MAY-17', 10, 1000);
INSERT INTO ORDERS VALUES(51, 450, '20-JAN-17', 10, 1000);
INSERT INTO ORDERS VALUES(52, 1000, '20-JAN-17', 13, 2000);
INSERT INTO ORDERS VALUES(53, 3500, '13-APR-17', 14, 3000);
INSERT INTO ORDERS VALUES(54, 550, '09-MAR-17', 12, 2000);

COMMIT;
```
## 3. View Tables
```sql
SELECT * FROM SALESMAN;
SELECT * FROM CUSTOMER;
SELECT * FROM ORDERS;
```

## 4. Queries Basic Queries
```sql
-- a. Count customers with grade above Bangalore average
SELECT COUNT(*) 
FROM CUSTOMER 
WHERE GRADE > (SELECT AVG(GRADE) FROM CUSTOMER WHERE CITY = 'BANGALORE');

-- b. Salesmen with more than one customer
SELECT S.SALESMAN_ID, S.NAME 
FROM SALESMAN S 
WHERE 1 < (SELECT COUNT(*) FROM CUSTOMER C WHERE C.SALESMAN_ID = S.SALESMAN_ID);

-- c. Salesman-customer city matches
SELECT S.SALESMAN_ID, S.NAME, C.CUSTOMER_NAME, S.COMMISSION 
FROM SALESMAN S 
JOIN CUSTOMER C ON S.CITY = C.CITY 
UNION 
SELECT S.SALESMAN_ID, S.NAME, 'NO_MATCH' AS CUSTOMER_NAME, S.COMMISSION 
FROM SALESMAN S 
WHERE S.CITY NOT IN (SELECT CITY FROM CUSTOMER);

-- d. Create view for elite salesmen
CREATE VIEW E_SALESMAN AS 
SELECT B.ORD_DATE, A.SALESMAN_ID, A.NAME 
FROM SALESMAN A 
JOIN ORDERS B ON A.SALESMAN_ID = B.SALESMAN_ID 
WHERE B.PURCHASE_AMT = (SELECT MAX(PURCHASE_AMT) FROM ORDERS C WHERE C.ORD_DATE = B.ORD_DATE);

-- e. Delete a salesman
DELETE FROM SALESMAN WHERE SALESMAN_ID=1000;
```

## Additional Queries
```sql
-- 1. Count customers by grade above Bangalore average
SELECT GRADE, COUNT(DISTINCT CUSTOMER_ID) 
FROM CUSTOMER 
GROUP BY GRADE 
HAVING GRADE > (SELECT AVG(GRADE) FROM CUSTOMER WHERE CITY='BANGALORE');

-- 2. Salesmen with multiple customers (alternative)
SELECT SALESMAN_ID, NAME 
FROM SALESMAN A 
WHERE 1 < (SELECT COUNT(*) FROM CUSTOMER WHERE SALESMAN_ID=A.SALESMAN_ID);

-- 3. Salesman-customer matches with ordering
SELECT SALESMAN.SALESMAN_ID, NAME, CUSTOMER_NAME, COMMISSION 
FROM SALESMAN, CUSTOMER
WHERE SALESMAN.CITY = CUSTOMER.CITY 
UNION 
SELECT SALESMAN_ID, NAME, 'NO MATCH', COMMISSION 
FROM SALESMAN 
WHERE NOT CITY = ANY (SELECT CITY FROM CUSTOMER) 
ORDER BY 2 DESC;
```
## 5. Extra Queries
```sql
-- 1. Average purchase amount by city
SELECT C.CITY, AVG(O.PURCHASE_AMT) AS AVG_PURCHASE  
FROM CUSTOMER C  
JOIN ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID  
GROUP BY C.CITY  
ORDER BY AVG_PURCHASE DESC;

-- 2. City with maximum total sales
SELECT C.CITY, SUM(O.PURCHASE_AMT) AS TOTAL_SALES  
FROM CUSTOMER C  
JOIN ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID  
GROUP BY C.CITY  
ORDER BY TOTAL_SALES DESC  
FETCH FIRST 1 ROWS ONLY;

-- 3. Salesman with most customers
SELECT S.SALESMAN_ID, S.NAME, COUNT(C.CUSTOMER_ID) AS TOTAL_CUSTOMERS  
FROM SALESMAN S  
LEFT JOIN CUSTOMER C ON S.SALESMAN_ID = C.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME  
ORDER BY TOTAL_CUSTOMERS DESC  
FETCH FIRST 1 ROWS ONLY;

-- 4. Oldest and newest order dates
SELECT MIN(ORD_DATE) AS OLDEST_ORDER, MAX(ORD_DATE) AS NEWEST_ORDER  
FROM ORDERS;

-- 5. Salesmen with no sales
SELECT S.SALESMAN_ID, S.NAME  
FROM SALESMAN S  
LEFT JOIN ORDERS O ON S.SALESMAN_ID = O.SALESMAN_ID  
WHERE O.ORD_ID IS NULL;

-- 6. Most expensive order and customer
SELECT O.ORD_ID, O.PURCHASE_AMT, C.CUSTOMER_NAME  
FROM ORDERS O  
JOIN CUSTOMER C ON O.CUSTOMER_ID = C.CUSTOMER_ID  
WHERE O.PURCHASE_AMT = (SELECT MAX(PURCHASE_AMT) FROM ORDERS);

-- 7. Salesmen with multiple customers
SELECT S.SALESMAN_ID, S.NAME, COUNT(C.CUSTOMER_ID) AS CUSTOMER_COUNT  
FROM SALESMAN S  
JOIN CUSTOMER C ON S.SALESMAN_ID = C.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME  
HAVING COUNT(C.CUSTOMER_ID) > 1;

-- 8. Average commission by city
SELECT CITY, AVG(CAST(REPLACE(COMMISSION, '%', '') AS FLOAT)) AS AVG_COMMISSION  
FROM SALESMAN  
GROUP BY CITY  
ORDER BY AVG_COMMISSION DESC;

-- 9. Create high-performers view
CREATE VIEW HIGH_PERFORMERS AS  
SELECT S.SALESMAN_ID, S.NAME, COUNT(O.ORD_ID) AS TOTAL_ORDERS, SUM(O.PURCHASE_AMT) AS TOTAL_SALES  
FROM SALESMAN S  
JOIN ORDERS O ON S.SALESMAN_ID = O.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME  
HAVING SUM(O.PURCHASE_AMT) > (SELECT AVG(PURCHASE_AMT) FROM ORDERS);

-- 10. Customers in multiple cities
SELECT CUSTOMER_ID, CUSTOMER_NAME, COUNT(DISTINCT CITY) AS UNIQUE_CITIES  
FROM CUSTOMER  
GROUP BY CUSTOMER_ID, CUSTOMER_NAME  
HAVING COUNT(DISTINCT CITY) > 1;

-- 11. Salesman with highest single sale
SELECT S.SALESMAN_ID, S.NAME, MAX(O.PURCHASE_AMT) AS HIGHEST_SALE  
FROM SALESMAN S  
JOIN ORDERS O ON S.SALESMAN_ID = O.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME  
ORDER BY HIGHEST_SALE DESC  
FETCH FIRST 1 ROWS ONLY;

-- 12. Rank salesmen by total sales
SELECT S.SALESMAN_ID, S.NAME, SUM(O.PURCHASE_AMT) AS TOTAL_SALES,  
RANK() OVER (ORDER BY SUM(O.PURCHASE_AMT) DESC) AS SALES_RANK  
FROM SALESMAN S  
JOIN ORDERS O ON S.SALESMAN_ID = O.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME;

-- 13. Customers with same grade
SELECT C1.CUSTOMER_NAME AS CUSTOMER_1, C2.CUSTOMER_NAME AS CUSTOMER_2, C1.GRADE  
FROM CUSTOMER C1, CUSTOMER C2  
WHERE C1.GRADE = C2.GRADE AND C1.CUSTOMER_ID < C2.CUSTOMER_ID  
ORDER BY C1.GRADE;

-- 14. Salesmen with no customers in their city
SELECT S.SALESMAN_ID, S.NAME, S.CITY  
FROM SALESMAN S  
WHERE S.CITY NOT IN (SELECT DISTINCT CITY FROM CUSTOMER);

-- 15. Salesman contribution percentage
SELECT S.SALESMAN_ID, S.NAME, SUM(O.PURCHASE_AMT) AS TOTAL_SALES,  
ROUND((SUM(O.PURCHASE_AMT) / (SELECT SUM(PURCHASE_AMT) FROM ORDERS)) * 100, 2) AS PERCENTAGE  
FROM SALESMAN S  
JOIN ORDERS O ON S.SALESMAN_ID = O.SALESMAN_ID  
GROUP BY S.SALESMAN_ID, S.NAME  
ORDER BY PERCENTAGE DESC;

```

## 6. Trigger Example
```sql
CREATE OR REPLACE TRIGGER prevent_delete  
BEFORE DELETE ON employees  
FOR EACH ROW  
BEGIN  
    RAISE_APPLICATION_ERROR(-20001, 'Row can''t be deleted');  
END;  
/
```