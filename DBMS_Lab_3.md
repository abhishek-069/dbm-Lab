# DBMS Lab - 3

## 1. Creating Tables

```sql
CREATE TABLE DEPTS (
    DNAME VARCHAR(20),
    DNO INT PRIMARY KEY,
    MGRSTRDATE DATE
);

CREATE TABLE EMP(
    SSN INT PRIMARY KEY,
    FNAME VARCHAR(20),
    LNAME VARCHAR(20),
    ADDRESS VARCHAR(20),
    SEX CHAR(1),
    SALARY INT,
    SUPERSSN REFERENCES EMP(SSN) ON DELETE CASCADE,
    DNO REFERENCES DEPTS(DNO) ON DELETE CASCADE
);

CREATE TABLE DEPTLOC (
    DNO REFERENCES DEPTS(DNO),
    DLOC VARCHAR(20)
);

CREATE TABLE PRJ (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(20),
    PLOC VARCHAR(20),
    DNO REFERENCES DEPTS(DNO)
);

CREATE TABLE WORK(
    SSN REFERENCES EMP(SSN),
    PNO REFERENCES PRJ(PNO),
    HOURS NUMBER(2)
);

ALTER TABLE DEPTS ADD MGRSSN REFERENCES EMP(SSN) ON DELETE SET NULL;
```
## 2. Inserting Data
```sql
-- Departments
INSERT INTO DEPTS (DNAME, DNO, MGRSTRDATE) VALUES ('ACCOUNTS', 1, '12-AUG-98');
INSERT INTO DEPTS (DNAME, DNO, MGRSTRDATE) VALUES('RESEARCH', 2, '24-JAN-00');
INSERT INTO DEPTS (DNAME, DNO, MGRSTRDATE) VALUES ('PRODUCTION', 3, '14-FEB-09');
INSERT INTO DEPTS (DNAME, DNO, MGRSTRDATE) VALUES('SALES', 4, '15-MAR-00');
INSERT INTO DEPTS (DNAME, DNO, MGRSTRDATE) VALUES ('TESTING', 5, '23-APR-02');

-- Employees
INSERT INTO EMP VALUES (111, 'JAMES', 'SCOTT', 'MYSORE', 'M', 123456, 111, 1);
INSERT INTO EMP VALUES (222, 'RAMESH', 'ARAVIND', 'BANGALORE', 'M', 345672, 111, 1);
INSERT INTO EMP VALUES (333, 'DAVID', 'HUSH', 'HONOLULU', 'M', 70000, 222, 1);
INSERT INTO EMP VALUES (444, 'KAVYA', 'BIND', 'GUWAHATI', 'F', 750000, 444, 1);
INSERT INTO EMP VALUES (555, 'HASHMI', 'KHAN', 'MUMBAI', 'F', 450000, 333, 1);
INSERT INTO EMP VALUES (666, 'PINKY', 'KHANNA', 'PUNJAB', 'F', 560000, 666, 1);
INSERT INTO EMP VALUES (777, 'KUSHAL', 'KUNDAN', 'ASSAM', 'M', 35000, 555, 4);
INSERT INTO EMP VALUES (888, 'ARIJITH', 'GUNDAL', 'ASSAM', 'M', 660000, 444, 5);

-- Projects
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (10, 'P1', 'BLORE', 1);
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (20, 'P2', 'MYSORE', 3);
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (30, 'P3', 'MUMBAI', 4);
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (40, 'P4', 'ASSAM', 4);
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (50, 'IOT', 'PUNJAB', 5);
INSERT INTO PRJ (PNO, PNAME, PLOC, DNO) VALUES (60, 'P6', 'HONULULU', 1);

-- Work assignments
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (111, 50, 5);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (222, 50, 10);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (333, 50, 7);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (444, 20, 8);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (555, 10, 3);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (666, 30, 1);
INSERT INTO WORK (SSN, PNO, HOURS) VALUES (777, 40, 12);

-- Update department managers
UPDATE DEPTS SET MGRSSN = 333 WHERE DNO = 1;
UPDATE DEPTS SET MGRSSN = 111 WHERE DNO = 2;
UPDATE DEPTS SET MGRSSN = 444 WHERE DNO = 3;
UPDATE DEPTS SET MGRSSN = 555 WHERE DNO = 4;
UPDATE DEPTS SET MGRSSN = 777 WHERE DNO = 5;
```
## 3. View Tables
```sql
SELECT * FROM EMP;
SELECT * FROM DEPTS;
SELECT * FROM PRJ;
SELECT * FROM WORK;
```
## 4. Queries Assignment Queries
```sql
-- A. Projects involving employee 'Scott' as worker or department manager
SELECT DISTINCT P.PNO 
FROM PRJ P, DEPTS D, EMP E 
WHERE E.DNO=D.DNO AND D.DNO = P.DNO 
AND (E.LNAME = 'SCOTT' OR D.MGRSSN IN (SELECT SSN FROM EMP WHERE LNAME='SCOTT'));

-- B. 10% raise for employees working on 'IoT' project
SELECT E.SSN, E.FNAME, E.LNAME, 1.1*E.SALARY AS RAISEDSAL 
FROM EMP E, PRJ P, WORK W 
WHERE P.PNAME = 'IOT' AND P.PNO = W.PNO AND E.SSN = W.SSN;

-- C. Salary statistics for 'Accounts' department
SELECT SUM(SALARY) AS SUMSAL, AVG(SALARY) AS AVGSAL, 
       MIN(SALARY) AS MINSAL, MAX(SALARY) AS MAXSAL 
FROM EMP E, DEPTS D 
WHERE E.DNO = D.DNO AND D.DNAME='ACCOUNTS';

-- D. Employees working on all projects controlled by department 5
SELECT E.FNAME, E.LNAME 
FROM EMP E 
WHERE NOT EXISTS (
    (SELECT PNO FROM PRJ WHERE DNO='5') 
    MINUS 
    (SELECT PNO FROM WORK WHERE E.SSN=SSN)
);

-- E. Departments with >5 employees and count of employees earning >600,000
SELECT D.DNO, D.DNAME, E.FNAME, E.LNAME, COUNT(*) AS NOOFEMP 
FROM EMP E, DEPTS D 
WHERE E.DNO=D.DNO AND E.SALARY>600000 
AND D.DNO IN(
    SELECT E1.DNO FROM EMP E1 
    GROUP BY E1.DNO 
    HAVING COUNT(*)>5
) 
GROUP BY D.DNO, D.DNAME, E.FNAME, E.LNAME;
```
## 5. Additional Operations
```sql
-- Update employee department
UPDATE EMP SET DNO = 50 WHERE SSN = 1;

-- Drop department table with constraints
DROP TABLE DEPTS CASCADE CONSTRAINTS;
```
## 6. Extra Queries (Potential Additions)
```sql
-- 1. List all employees and their managers
SELECT E.FNAME, E.LNAME, M.FNAME AS MANAGER_FNAME, M.LNAME AS MANAGER_LNAME
FROM EMP E LEFT JOIN EMP M ON E.SUPERSSN = M.SSN;

-- 2. Projects with most working hours
SELECT P.PNAME, SUM(W.HOURS) AS TOTAL_HOURS
FROM PRJ P JOIN WORK W ON P.PNO = W.PNO
GROUP BY P.PNAME
ORDER BY TOTAL_HOURS DESC
FETCH FIRST 1 ROWS ONLY;

-- 3. Departments with average salary > company average
SELECT D.DNAME, AVG(E.SALARY) AS AVG_SALARY
FROM DEPTS D JOIN EMP E ON D.DNO = E.DNO
GROUP BY D.DNAME
HAVING AVG(E.SALARY) > (SELECT AVG(SALARY) FROM EMP);

-- 4. Employees working on multiple projects
SELECT E.FNAME, E.LNAME, COUNT(W.PNO) AS PROJECT_COUNT
FROM EMP E JOIN WORK W ON E.SSN = W.SSN
GROUP BY E.FNAME, E.LNAME
HAVING COUNT(W.PNO) > 1;

-- 5. Department locations and their projects
SELECT D.DNAME, DL.DLOC, P.PNAME
FROM DEPTS D 
JOIN DEPTLOC DL ON D.DNO = DL.DNO
JOIN PRJ P ON D.DNO = P.DNO;
```